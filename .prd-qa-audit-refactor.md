# PRD: QA/Audit 系统重构 - 三层架构落地

## 背景

当前 QA/Audit 系统存在问题：
1. QA Node 缺少触发规则（不知道什么时候必须做）
2. 缺少 RISK SCORE 机制（靠直觉判断复杂度）
3. QA-DECISION.md 是作文式（不可执行）
4. Audit Node 无法自动验证（缺少结构化对比）
5. Skills、Scripts、Templates 职责混乱

## 目标

建立三层架构：
- **Layer 1: Skills (SKILL.md)** - AI 操作手册
- **Layer 2: Scripts (可执行工具)** - 实际计算和扫描
- **Layer 3: Templates (输出格式)** - 结构化模板

## RISK SCORE 机制

风险项（每项 1 分）：
- R1: 改公共 API
- R2: 改数据模型（schema/state/summary）
- R3: 跨模块改动 >= 2 个 packages
- R4: 引入新依赖
- R5: 涉及权限/安全/密钥/文件/命令
- R6: 改核心流程（/dev /audit /ci-gate /pr-gate）
- R7: 改默认行为（feature flag / fallback）
- R8: 涉及金额/支付/结算

**触发规则**：
- RISK ≥ 3 → 必须执行 QA Node
- RISK < 3 → 可跳过 QA Node

## 实现范围

### 新增文件

**Scripts（可执行工具）**：
- `scripts/qa/risk-score.js` - 计算风险分数
- `scripts/qa/detect-scope.js` - 自动建议允许范围
- `scripts/qa/detect-forbidden.js` - 自动检测禁区
- `scripts/audit/compare-scope.js` - 对比实际改动与允许范围
- `scripts/audit/check-forbidden.js` - 检查是否触碰禁区
- `scripts/audit/check-proof.js` - 验证证据是否完整
- `scripts/audit/generate-report.js` - 生成审计报告

**Templates（结构化模板）**：
- `templates/QA-DECISION.md` - QA 决策模板
- `templates/AUDIT-REPORT.md` - 审计报告模板

### 更新文件

**Skills（AI 手册）**：
- `skills/qa/SKILL.md` - 更新为包含 RISK SCORE 触发逻辑
- `skills/audit/SKILL.md` - 更新为结构化验证流程

## 成功标准

1. 所有脚本可独立运行并输出 JSON
2. RISK SCORE 计算准确（测试 10 个真实 PR diff）
3. QA-DECISION.md 格式结构化（可被 Audit 解析）
4. Audit Node 可自动对比并生成 PASS/FAIL
5. 集成到 /dev 流程（Step 4 + Step 7）

## 版本

v11.0.0（重大架构调整）
