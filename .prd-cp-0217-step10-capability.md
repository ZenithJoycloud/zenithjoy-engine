---
id: prd-step10-capability-update
version: 1.0.0
created: 2026-02-17
updated: 2026-02-17
changelog:
  - 1.0.0: 初始版本
---

# PRD: /dev Step 10 — 自动更新 Capability Stage

## 功能描述

PR 合并后自动通过 Brain API 更新关联的 Capability stage，让向量记忆库实时反映系统成熟度。

## 背景

`/dev` 工作流完成后（PR 合并），如果该任务关联了一个 Capability（通过 `pr_plan.capability_id` + `pr_plan.to_stage`），需要自动调用 Brain API 更新该 Capability 的 `current_stage`。

目前 Step 10 只记录 Learning，不更新 Capability，导致向量记忆库中的 Capability 阶段长期停滞，无法反映系统实际成熟度。

## 目标

PR 合并后，Step 10 自动：
1. 检查 `.dev-mode` 中的 `task_id`
2. 通过 Brain API 找到关联的 `pr_plan.capability_id` + `to_stage`
3. 调用 `PATCH /api/brain/capabilities/:id` 更新阶段
4. 打印简洁状态（✅ / ⚠️ 静默失败）

## 范围

- **新增脚本**：`skills/dev/scripts/update-capability.sh`
- **更新文档**：`skills/dev/steps/10-learning.md` — 在 Learning 记录后调用脚本

## 非范围

- 不创建新 Capability（只更新已有的）
- Brain 不可用时静默跳过（不阻塞流程）

## 技术细节

### `.dev-mode` 格式

```
dev
branch: cp-xxx
prd: .prd.md
task_id: abc-123
```

### Brain API 调用链

```
GET /api/brain/tasks/:task_id → pr_plan_id
GET /api/brain/pr_plans/:id   → capability_id, to_stage
PATCH /api/brain/capabilities/:capability_id → { current_stage: to_stage, evidence: "PR merged via /dev" }
```

### 降级策略

- Brain 不可用 → 打印 ⚠️ 跳过，继续流程
- task_id 不存在 → 静默跳过
- pr_plan 无 capability_id → 静默跳过
- current_stage ≥ to_stage → 打印提示，跳过（不回退）
