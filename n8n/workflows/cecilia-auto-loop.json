{
  "name": "Cecilia Auto Loop - 无头开发循环",
  "active": true,
  "nodes": [
    {
      "id": "webhook-trigger",
      "name": "接收任务",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 300],
      "parameters": {
        "httpMethod": "POST",
        "path": "cecilia-loop",
        "responseMode": "responseNode",
        "options": {}
      }
    },
    {
      "id": "init-task",
      "name": "初始化任务",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [400, 300],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "task_id", "name": "task_id", "value": "={{ $json.body.task_id || $now.format('yyyyMMdd-HHmmss') }}", "type": "string"},
            {"id": "project", "name": "project", "value": "={{ $json.body.project || 'zenithjoy-core' }}", "type": "string"},
            {"id": "work_dir", "name": "work_dir", "value": "={{ $json.body.work_dir || '/home/xx/dev/' + $json.body.project }}", "type": "string"},
            {"id": "initial_prompt", "name": "initial_prompt", "value": "={{ $json.body.prompt }}", "type": "string"},
            {"id": "current_stage", "name": "current_stage", "value": "={{ $json.body.stage || 1 }}", "type": "number"},
            {"id": "max_retries", "name": "max_retries", "value": "={{ $json.body.max_retries || 3 }}", "type": "number"},
            {"id": "retry_count", "name": "retry_count", "value": "=0", "type": "number"},
            {"id": "status", "name": "status", "value": "started", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "respond-accepted",
      "name": "返回任务ID",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [600, 200],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, task_id: $json.task_id, message: 'Task accepted, processing...' }) }}"
      }
    },
    {
      "id": "call-cecilia",
      "name": "调用 Cecilia",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [800, 300],
      "parameters": {
        "method": "POST",
        "url": "http://localhost:8899/execute",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"prompt\": \"{{ $json.initial_prompt }}\",\n  \"work_dir\": \"{{ $json.work_dir }}\",\n  \"task_id\": \"{{ $json.task_id }}\",\n  \"stage\": {{ $json.current_stage }}\n}",
        "options": {
          "timeout": 600000
        }
      }
    },
    {
      "id": "check-cecilia-result",
      "name": "检查执行结果",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1000, 300],
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "has-pr",
              "leftValue": "={{ $json.pr_url }}",
              "rightValue": "",
              "operator": {"type": "string", "operation": "notEmpty"}
            }
          ],
          "combinator": "and"
        }
      }
    },
    {
      "id": "wait-ci",
      "name": "等待 CI (60s)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1200, 200],
      "parameters": {
        "amount": 60,
        "unit": "seconds"
      }
    },
    {
      "id": "check-ci-status",
      "name": "检查 CI 状态",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1400, 200],
      "parameters": {
        "method": "GET",
        "url": "=https://api.github.com/repos/anthropic-ai/{{ $('init-task').item.json.project }}/commits/{{ $json.commit_sha }}/check-runs",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      }
    },
    {
      "id": "ci-passed",
      "name": "CI 通过?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1600, 200],
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "ci-success",
              "leftValue": "={{ $json.check_runs?.every(r => r.conclusion === 'success') }}",
              "rightValue": true,
              "operator": {"type": "boolean", "operation": "true"}
            }
          ],
          "combinator": "and"
        }
      }
    },
    {
      "id": "increment-retry",
      "name": "增加重试次数",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1800, 400],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "retry_count", "name": "retry_count", "value": "={{ $('init-task').item.json.retry_count + 1 }}", "type": "number"},
            {"id": "initial_prompt", "name": "initial_prompt", "value": "CI 失败，请修复以下问题并重新提交 PR:\n{{ $json.check_runs?.filter(r => r.conclusion !== 'success').map(r => r.name + ': ' + r.output?.summary).join('\\n') }}", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "check-max-retry",
      "name": "超过最大重试?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2000, 400],
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "max-retry",
              "leftValue": "={{ $json.retry_count }}",
              "rightValue": "={{ $('init-task').item.json.max_retries }}",
              "operator": {"type": "number", "operation": "gte"}
            }
          ],
          "combinator": "and"
        }
      }
    },
    {
      "id": "next-stage",
      "name": "进入下一阶段",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1800, 100],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "current_stage", "name": "current_stage", "value": "={{ $('init-task').item.json.current_stage + 1 }}", "type": "number"},
            {"id": "retry_count", "name": "retry_count", "value": "=0", "type": "number"},
            {"id": "status", "name": "status", "value": "stage_completed", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "check-more-stages",
      "name": "还有更多阶段?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2000, 100],
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "has-next",
              "leftValue": "={{ $json.current_stage }}",
              "rightValue": "={{ $('init-task').item.json.total_stages || 1 }}",
              "operator": {"type": "number", "operation": "lte"}
            }
          ],
          "combinator": "and"
        }
      }
    },
    {
      "id": "task-completed",
      "name": "任务完成",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [2200, 100],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "status", "name": "status", "value": "completed", "type": "string"},
            {"id": "message", "name": "message", "value": "所有阶段已完成", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "task-failed",
      "name": "任务失败",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [2200, 500],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "status", "name": "status", "value": "failed", "type": "string"},
            {"id": "message", "name": "message", "value": "超过最大重试次数", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "execution-failed",
      "name": "执行失败",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1200, 400],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "status", "name": "status", "value": "execution_failed", "type": "string"},
            {"id": "message", "name": "message", "value": "Cecilia 执行失败，未创建 PR", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "notify-complete",
      "name": "通知完成",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2400, 300],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.NOTIFICATION_WEBHOOK || 'http://localhost:3000/api/notifications' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"task_id\": \"{{ $('init-task').item.json.task_id }}\",\n  \"status\": \"{{ $json.status }}\",\n  \"message\": \"{{ $json.message }}\",\n  \"project\": \"{{ $('init-task').item.json.project }}\"\n}"
      }
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [[{"node": "init-task", "type": "main", "index": 0}]]
    },
    "init-task": {
      "main": [
        [
          {"node": "respond-accepted", "type": "main", "index": 0},
          {"node": "call-cecilia", "type": "main", "index": 0}
        ]
      ]
    },
    "call-cecilia": {
      "main": [[{"node": "check-cecilia-result", "type": "main", "index": 0}]]
    },
    "check-cecilia-result": {
      "main": [
        [{"node": "wait-ci", "type": "main", "index": 0}],
        [{"node": "execution-failed", "type": "main", "index": 0}]
      ]
    },
    "wait-ci": {
      "main": [[{"node": "check-ci-status", "type": "main", "index": 0}]]
    },
    "check-ci-status": {
      "main": [[{"node": "ci-passed", "type": "main", "index": 0}]]
    },
    "ci-passed": {
      "main": [
        [{"node": "next-stage", "type": "main", "index": 0}],
        [{"node": "increment-retry", "type": "main", "index": 0}]
      ]
    },
    "increment-retry": {
      "main": [[{"node": "check-max-retry", "type": "main", "index": 0}]]
    },
    "check-max-retry": {
      "main": [
        [{"node": "task-failed", "type": "main", "index": 0}],
        [{"node": "call-cecilia", "type": "main", "index": 0}]
      ]
    },
    "next-stage": {
      "main": [[{"node": "check-more-stages", "type": "main", "index": 0}]]
    },
    "check-more-stages": {
      "main": [
        [{"node": "call-cecilia", "type": "main", "index": 0}],
        [{"node": "task-completed", "type": "main", "index": 0}]
      ]
    },
    "task-completed": {
      "main": [[{"node": "notify-complete", "type": "main", "index": 0}]]
    },
    "task-failed": {
      "main": [[{"node": "notify-complete", "type": "main", "index": 0}]]
    },
    "execution-failed": {
      "main": [[{"node": "notify-complete", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
