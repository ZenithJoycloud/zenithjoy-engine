---
id: prd-worktree-auto-detect
version: 1.0.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
---

## PRD - Worktree 自动检测与创建

**需求来源**: 用户在有活跃 .dev-mode 的仓库启动新任务时，AI 只报错让用户手动开 worktree + 新终端，无法自动继续。

**功能描述**: 当 /dev 启动时，在 Step 1 之前自动检测主仓库是否有活跃 .dev-mode。如果有，自动创建 worktree 并 cd 过去，然后继续正常的 /dev 流程。PRD 文件直接在 worktree 中创建，避免文件丢失问题。

**涉及文件**:
- `skills/dev/steps/00-worktree-auto.md`（新建）- 前置步骤，自动检测+创建 worktree
- `skills/dev/steps/02-detect.md`（修改）- 移除 worktree 检测段（职责移到 Step 0）
- `skills/dev/steps/03-branch.md`（修改）- 冲突检测改为自动 worktree 兜底（不再 exit 1）
- `skills/dev/SKILL.md`（修改）- 加载策略和流程图增加 Step 0
- `skills/dev/scripts/worktree-manage.sh`（修改）- 创建加 flock 防并发
- `FEATURES.md`（修改）- W6 更新说明

**成功标准**:
- 主仓库有活跃 .dev-mode 时，/dev 自动创建 worktree 并 cd 过去继续流程
- 僵尸 .dev-mode（超过 2 小时无活跃 session）自动清理，不创建 worktree
- worktree 创建有 flock 锁，多个 Cecelia 并发不会竞争
- worktree 内自动安装依赖（检测 package.json → npm install）
- Step 3 保留冲突检测作为兜底，不再 exit 1

**非目标**:
- 不改 branch-protect.sh hook（它不管 worktree 冲突）
- 不改 stop.sh hook（已有 session 隔离）
- 不重构整体步骤编号（保持 01-11，新增 00 前置）
