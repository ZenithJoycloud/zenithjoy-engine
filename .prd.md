# PRD: CI P1 遗留问题修复 - L2A/L2B 结构验证强化

## 背景

在 2026-01-30 的 CI 硬化审计中，发现了两个 P1 级别问题：
- **P1-1**: L2A/L2B 只查字符串存在，不验证结构和密度
- **P1-2**: RCI 覆盖率匹配太松（`name.includes()`），允许假覆盖

虽然标记为 P1，但这两个问题的安全影响类似 P2，需要进一步强化。

## 问题详情

### P1-1: L2A/L2B 结构验证不足

**当前状态**：
- L2A (l2a-check.sh) 只检查文件存在
- L2B (l2b-check.sh) 只检查字符串包含
- 没有验证内容结构和质量

**问题**：
- 可以用空文件或无意义内容绕过检查
- PRD 可以只有一个 `##` 标题
- DoD 可以只有一个空 checkbox
- Evidence 可以只有一行"测试通过"

**安全影响**: Medium-High（允许低质量产物通过检查）

### P1-2: RCI 覆盖率匹配过松

**当前状态** (`scan-rci-coverage.cjs`):
```javascript
if (contract.name.includes(entry.name)) {
  coveredBy.push(contract.id);
}
```

**问题**：
- "user" 会匹配 "user-service.ts"、"utils.ts"、"super-user.ts"
- 导致误报覆盖率
- 可以用模糊匹配绕过真实覆盖检查

**安全影响**: Medium（允许假覆盖率通过检查）

## 解决方案

### P1-1 修复：增强 L2A/L2B 结构检查

#### L2A 增强 (l2a-check.sh)

**PRD 检查**：
- 最少 3 个 section (`##`)
- 每个 section 至少 2 行非空内容
- 必须包含关键字段：背景/问题/方案

**DoD 检查**：
- 最少 3 个验收项 (`- [ ]` 或 `- [x]`)
- 每个验收项必须有 `Test:` 映射
- Test 映射格式必须有效（`auto:` 或 `manual:`）

#### L2B 增强 (l2b-check.sh)

**Evidence 检查**：
- 必须有可复现命令（bash, npm, node, curl）
- 或有机器引用（SHA, run ID, hash）
- 不接受纯文字描述
- 截图必须存在且非空

### P1-2 修复：收紧 RCI 覆盖匹配

修改 `scan-rci-coverage.cjs` 匹配逻辑：

```javascript
// 移除 name.includes() 误判逻辑
// 只允许三种精确匹配：

// 1. 路径精确匹配
if (entry.path === contractPath) {
  coveredBy.push(contract.id);
}

// 2. 目录匹配
else if (contractPath.endsWith("/") && entry.path.startsWith(contractPath)) {
  coveredBy.push(contract.id);
}

// 3. glob 匹配
else if (contractPath.includes("*")) {
  const regex = globToRegex(contractPath);
  if (regex.test(entry.path)) {
    coveredBy.push(contract.id);
  }
}
```

## 成功标准

### L2A/L2B 增强
- [ ] PRD 必须有 ≥3 个 section，每个 section ≥2 行内容
- [ ] DoD 必须有 ≥3 个验收项，每个都有有效 Test 映射
- [ ] Evidence 必须有可复现命令或机器引用
- [ ] 空文件或低质量内容被拒绝

### RCI 覆盖率收紧
- [ ] 移除 `name.includes()` 误判逻辑
- [ ] 只使用路径精确匹配、目录匹配、glob 匹配
- [ ] 假覆盖被检测并报错
- [ ] 真覆盖正确识别

### 测试覆盖
- [ ] l2a-check.sh 新增结构检查测试
- [ ] l2b-check.sh 新增可复现性检查测试
- [ ] scan-rci-coverage.cjs 新增匹配精度测试
- [ ] 所有测试通过

### 版本更新
- [ ] 版本号 12.2.0 → 12.3.0 (minor bump，新功能)
- [ ] CHANGELOG 记录 P1-1 和 P1-2 修复
- [ ] regression-contract.yaml 更新版本

## 优先级

**Priority**: P1（等同 P2 安全影响）

**Rationale**:
- P1-1 影响产物质量，可能导致空内容通过检查
- P1-2 影响覆盖率准确性，可能导致假覆盖
- 两者都是安全相关的验证漏洞
- 需要在下一个 release 前修复

## 非目标

- ❌ 不实现 AI 内容质量检查（超出范围）
- ❌ 不重构整个 L2A/L2B 系统（只增强检查）
- ❌ 不修改 RCI 数据结构（只修改匹配逻辑）

## 技术细节

### L2A 实现

```bash
# PRD section 检查
SECTION_COUNT=$(grep -c "^## " "$PRD_FILE")
if [[ $SECTION_COUNT -lt 3 ]]; then
  echo "❌ PRD 必须有至少 3 个 section"
  exit 1
fi

# 每个 section 内容检查
for section in $(grep -n "^## " "$PRD_FILE" | cut -d: -f1); do
  NEXT_SECTION=$(grep -n "^## " "$PRD_FILE" | grep -A 1 "^${section}:" | tail -1 | cut -d: -f1)
  CONTENT_LINES=$(sed -n "${section},${NEXT_SECTION}p" "$PRD_FILE" | grep -cv "^$\|^## ")
  if [[ $CONTENT_LINES -lt 2 ]]; then
    echo "❌ PRD section 内容不足（需要至少 2 行）"
    exit 1
  fi
done
```

### L2B 实现

```bash
# 可复现性检查
HAS_COMMAND=$(grep -E "(bash|npm|node|curl|git|docker)" "$EVIDENCE_FILE" | wc -l)
HAS_MACHINE_REF=$(grep -E "(SHA|run.*ID|hash|commit)" "$EVIDENCE_FILE" | wc -l)

if [[ $HAS_COMMAND -eq 0 && $HAS_MACHINE_REF -eq 0 ]]; then
  echo "❌ Evidence 缺少可复现命令或机器引用"
  exit 1
fi
```

### RCI 匹配实现

```javascript
function matchPath(contractPath, entryPath) {
  // 精确匹配
  if (entryPath === contractPath) return true;

  // 目录匹配
  if (contractPath.endsWith("/") && entryPath.startsWith(contractPath)) {
    return true;
  }

  // glob 匹配
  if (contractPath.includes("*")) {
    const regex = globToRegex(contractPath);
    return regex.test(entryPath);
  }

  return false;
}
```

## 风险

### 破坏现有工作流
- **风险**: 加强检查可能导致现有合法 PRD/DoD/Evidence 被拒绝
- **缓解**: 设置合理的阈值（3 section, 2 line, 3 checkbox）
- **缓解**: 提供清晰的错误消息指导修复

### RCI 匹配变严格
- **风险**: 原本误判为覆盖的测试会暴露为未覆盖
- **缓解**: 这是预期行为，修复假覆盖
- **缓解**: CI 会标记未覆盖的 RCI，提示补充测试

## 依赖

- 无外部依赖
- 修改现有文件：`scripts/devgate/l2a-check.sh`, `scripts/devgate/l2b-check.sh`, `ci/scripts/scan-rci-coverage.cjs`

## 时间线

- **实现**: 1 个开发周期（/dev workflow）
- **测试**: 包含在 /dev Step 6
- **部署**: PR 合并后自动生效
