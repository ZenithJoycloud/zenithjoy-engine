# PRD - 修复 CI 规则与证据文件自动化

## 问题

三个系统性问题每次 PR 都会遇到：

### 1. PRD/DoD missing (cleanup 悖论)
- 清理类任务 (chore:) 需要 PR
- PR 需要 PRD/DoD
- 但任务目标就是删除 PRD/DoD
- 形成循环依赖

### 2. Version not updated
- CI 强制要求每个 PR 更新版本号
- chore:/docs:/test: commits 不应该要求版本变更
- 只有 feat:/fix:/breaking: 才需要版本更新

### 3. Evidence SHA mismatch
- 每次都忘记运行 `npm run qa:gate` 更新证据文件
- 依赖手动记忆，容易遗漏
- 应该自动化到工作流中

## 解决方案

### 1. CI 规则优化

**L2A Check 跳过 chore commits**:
```yaml
# .github/workflows/ci.yml
- name: L2A Check
  if: |
    steps.detect.outputs.type == 'npm' &&
    github.base_ref != 'main' &&
    !startsWith(github.event.head_commit.message, 'chore:')
```

**Version Check 跳过 chore/docs/test**:
```yaml
- name: Check package.json version updated
  if: |
    !startsWith(github.event.head_commit.message, 'chore:') &&
    !startsWith(github.event.head_commit.message, 'docs:') &&
    !startsWith(github.event.head_commit.message, 'test:')
```

### 2. Evidence 自动化

在 package.json 添加 pre-commit 提示或在 dev skill 中固化流程：
```bash
# 代码变更后自动提醒
git commit -m "feat: xxx" && npm run qa:gate && git add .quality-evidence.json .quality-gate-passed && git commit -m "chore: update quality evidence"
```

### 3. 清理残留文件

删除 develop 分支上 PR #298 的残留：
- .prd.md
- .dod.md
- .layer2-evidence.md

## 验收标准

参见 .dod.md

## 优先级

P1 - 影响所有后续 PR 的系统性问题
