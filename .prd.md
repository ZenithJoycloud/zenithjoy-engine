# PRD - 修复 Self-Evolution 设计缺陷

## 需求来源

用户反馈：
1. PRD/DoD 残留导致无限循环 - squash merge 会把 cleanup PR 的 PRD/DoD 也合并进来
2. Self-evolution 应该异步处理，记录到队列，而不是发现问题立即修复

## 功能描述

### 问题 1：PRD/DoD 残留循环

**现状**：
```
cleanup PR (删除 .prd.md, .dod.md)
  但分支上有自己的 .prd.md 和 .dod.md
     ↓
squash merge 到 develop
     ↓
develop 上又有了 .prd.md 和 .dod.md
     ↓
post-pr-checklist.sh 报错
     ↓
创建新的 cleanup PR
     ↓
无限循环 ❌
```

**解决方案**：
- 修改 `post-pr-checklist.sh`：发现 PRD/DoD 时记录到队列，不报错退出
- 创建 `scripts/cleanup-prd-dod.sh`：在 develop/main 分支 CI 后自动清理
- 集成到 CI workflow

### 问题 2：Self-evolution 立即执行

**现状**：
```
post-pr-checklist.sh 发现问题
     ↓
AI 立即创建 PR 修复
     ↓
又发现问题
     ↓
又立即修复
     ↓
循环多次... ❌
```

**解决方案**：
- 创建 `docs/SELF-EVOLUTION-QUEUE.md` 作为待处理队列
- `post-pr-checklist.sh` 只记录问题，不阻塞流程
- 定时任务/手动触发时处理队列中的问题

## 涉及文件

**新建**：
- `docs/SELF-EVOLUTION-QUEUE.md` - 待处理队列
- `scripts/cleanup-prd-dod.sh` - PRD/DoD 自动清理脚本

**修改**：
- `scripts/post-pr-checklist.sh` - 改为记录问题而不是报错
- `docs/SELF-EVOLUTION.md` - 更新工作流程说明
- `.github/workflows/ci.yml` - 集成 cleanup 脚本

## 成功标准

- [x] `docs/SELF-EVOLUTION-QUEUE.md` 已创建，包含队列格式说明
- [x] `scripts/cleanup-prd-dod.sh` 已创建，可自动删除 develop/main 上的 PRD/DoD
- [x] `post-pr-checklist.sh` 修改为记录模式（发现问题 → 写入队列 → exit 0）
- [x] `docs/SELF-EVOLUTION.md` 更新，说明新的异步处理流程
- [x] CI workflow 集成 cleanup 脚本
- [x] 测试：在 develop 分支运行 cleanup 脚本，确认可删除 PRD/DoD
- [x] 测试：post-pr-checklist 发现问题后写入队列，不报错退出
