# DoD: Gate 强制执行机制

## 验收清单

### 核心功能

- [ ] 创建 `scripts/gate/generate-gate-file.sh`，生成带签名的 gate 文件
  Test: tests/gate/generate-gate-file.test.ts

- [ ] 创建 `scripts/gate/verify-gate-signature.sh`，验证 gate 文件签名
  Test: tests/gate/verify-gate-signature.test.ts

- [ ] 修改 `hooks/branch-protect.sh`，在 step >= 2 时检查 `.gate-prd-passed`
  Test: tests/hooks/branch-protect-gate.test.ts

- [ ] 修改 `hooks/branch-protect.sh`，在 step >= 5 时检查 `.gate-dod-passed`
  Test: tests/hooks/branch-protect-gate.test.ts

- [ ] 修改 `hooks/branch-protect.sh`，在 step >= 7 时检查 `.gate-test-passed`
  Test: tests/hooks/branch-protect-gate.test.ts

- [ ] 修改 `hooks/pr-gate-v2.sh`，检查 `.gate-prd-passed`、`.gate-dod-passed`、`.gate-test-passed`、`.gate-audit-passed` 四个文件
  Test: tests/hooks/pr-gate-gate.test.ts

### 失败场景

- [ ] Gate 文件不存在时，输出 `❌ 必须先通过 gate:xxx 审核` 并 exit 2
  Test: tests/hooks/branch-protect-gate.test.ts

- [ ] 签名验证失败时，输出 `❌ gate 文件签名无效（expected: xxx, got: yyy）` 并 exit 2
  Test: tests/gate/verify-gate-signature.test.ts

- [ ] 分支名不匹配时，输出 `❌ gate 文件分支不匹配（file: cp-aaa, current: cp-bbb）` 并 exit 2
  Test: tests/gate/verify-gate-signature.test.ts

### Secret 管理

- [ ] 首次运行时自动生成 `~/.claude/.gate-secret`（32 字节随机，64 字符 hex）
  Test: manual:删除~/.claude/.gate-secret后运行generate-gate-file.sh验证文件自动生成且长度64字符

- [ ] Secret 文件权限设为 600（仅 owner 可读写）
  Test: manual:ls-la验证权限为-rw-------

### 清理

- [ ] `.gate-*-passed` 加入 `.gitignore`
  Test: manual:grep验证.gitignore包含.gate-*-passed

- [ ] `skills/dev/scripts/cleanup.sh` 删除所有 `.gate-*-passed` 文件
  Test: manual:创建测试文件运行cleanup验证被删除

## 质量参考

QA: docs/QA-DECISION-cp-0130-gate-enforce.md
