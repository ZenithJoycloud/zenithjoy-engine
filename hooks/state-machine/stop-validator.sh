#!/bin/bash
# ============================================================================
# Stop Hook: 真正的验证器（100% 可靠）
# ============================================================================
#
# 核心原理：
#   - 不信任任何状态文件（Claude 可以篡改）
#   - 自己真正运行测试来验证
#   - 测试不通过？exit 2 打回去
#
# 这是唯一 100% 可靠的方案：自己验证，不信任任何中间状态
#
# ============================================================================

set -e

# 配置
REQUIRE_TESTS="${REQUIRE_TESTS:-true}"
PROJECT_ROOT="${PROJECT_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"

# ============================================================================
# 真正运行测试验证
# ============================================================================

run_real_test() {
    if [[ ! -f "$PROJECT_ROOT/package.json" ]]; then
        return 0  # 没有 package.json，跳过
    fi

    if ! grep -q '"test"' "$PROJECT_ROOT/package.json"; then
        return 0  # 没有 test script，跳过
    fi

    cd "$PROJECT_ROOT"
    if npm test >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# ============================================================================
# 主逻辑
# ============================================================================

INPUT=$(cat)

# 防止无限循环
STOP_HOOK_ACTIVE=$(echo "$INPUT" | jq -r '.stop_hook_active // false' 2>/dev/null)
if [[ "$STOP_HOOK_ACTIVE" == "true" ]]; then
    exit 0
fi

# ============================================================================
# 真正验证：自己跑测试，不信任任何状态文件
# ============================================================================

if [[ "$REQUIRE_TESTS" == "true" ]]; then
    echo "" >&2
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
    echo "  STOP HOOK: 正在验证（自己跑测试）..." >&2
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2

    if ! run_real_test; then
        echo "" >&2
        echo "  ❌ npm test 失败" >&2
        echo "" >&2
        echo "  我不信任任何状态文件，我自己跑了测试。" >&2
        echo "  测试没通过，你不能退出。" >&2
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
        echo "" >&2
        exit 2
    fi

    echo "  ✅ npm test 通过" >&2
fi

echo "" >&2
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
echo "  STOP HOOK: 验证通过，允许退出" >&2
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
echo "" >&2

exit 0
